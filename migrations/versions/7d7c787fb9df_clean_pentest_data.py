"""clean_pentest_data

Revision ID: 7d7c787fb9df
Revises: c00e60380604
Create Date: 2023-01-31 16:51:38.646367

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy import text
from sqlalchemy.orm import Session

# revision identifiers, used by Alembic.
revision = "7d7c787fb9df"
down_revision = "c00e60380604"
branch_labels = None
depends_on = None


def upgrade():
    session = Session(bind=op.get_bind())

    # User ids used to id data
    user_ids_to_delete = session.execute(
        """
            SELECT u.id
            FROM public.user u 
            WHERE u.email LIKE '%cyberlab%'
        """
    )
    user_ids_to_delete = [str(u[0]) for u in user_ids_to_delete]
    if len(user_ids_to_delete) == 0:
        print(f"No data to be deleted found")
        return
    user_ids_to_delete_str = ",".join(user_ids_to_delete)

    # Employment/Company ids used to id data
    employments_to_delete = session.execute(
        f"""
            SELECT e.company_id, e.id FROM public.employment e
            WHERE e.submitter_id IN ({user_ids_to_delete_str})
        """
    )
    employments_to_delete = list(employments_to_delete)
    company_ids_to_delete = [str(item[0]) for item in employments_to_delete]
    employment_ids_to_delete = [str(item[1]) for item in employments_to_delete]
    company_ids_to_delete_str = ",".join(company_ids_to_delete)
    employment_ids_to_delete_str = ",".join(employment_ids_to_delete)

    # Mission ids used to id data
    missions_to_delete = session.execute(
        f"""
            SELECT m.id FROM public.mission m
            WHERE m.company_id IN ({company_ids_to_delete_str})
        """
    )
    mission_ids_to_delete = [str(item[0]) for item in missions_to_delete]
    mission_ids_to_delete_str = ",".join(mission_ids_to_delete)

    # Activity ids used to id data
    activities_to_delete = session.execute(
        f"""
            SELECT a.id FROM public.activity a
            WHERE a.mission_id IN ({mission_ids_to_delete_str})
        """
    )
    activity_ids_to_delete = [str(item[0]) for item in activities_to_delete]
    activity_ids_to_delete_str = ",".join(activity_ids_to_delete)

    session.execute(
        f"""
            DELETE FROM public.user_read_token urt
            WHERE urt.user_id IN ({user_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.refresh_token rt
            WHERE rt.user_id IN ({user_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.email e
            WHERE e.user_id IN ({user_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.regulation_computation rc
            WHERE rc.user_id IN ({user_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.company_known_address cka
            WHERE cka.company_id IN ({company_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.comment c
            WHERE c.mission_id IN ({mission_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.expenditure ex
            WHERE ex.mission_id IN ({mission_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.location_entry le
            WHERE le.mission_id IN ({mission_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.mission_validation mv
            WHERE mv.mission_id IN ({mission_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.mission_end me
            WHERE me.mission_id IN ({mission_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.activity_version av
            WHERE av.activity_id IN ({activity_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.activity a
            WHERE a.id IN ({activity_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.mission m
            WHERE m.id IN ({mission_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.vehicle v
            WHERE v.company_id IN ({company_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.employment e
            WHERE e.id IN ({employment_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.company c
            WHERE c.id IN ({company_ids_to_delete_str})
        """
    )
    session.execute(
        f"""
            DELETE FROM public.user u
            WHERE u.id IN ({user_ids_to_delete_str})
        """
    )


def downgrade():
    pass
